<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Walk (Gesture) - Mengxi Times</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Unified Design System -->
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="css/unified-styles.css">

    <style>
        body.theme-education {
            background: linear-gradient(135deg, var(--education-primary), var(--education-secondary));
            min-height: 100vh;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: var(--space-md);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        #gameArea {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: var(--space-lg);
            margin-bottom: var(--space-lg);
        }

        /* Camera Section */
        #cameraSection {
            text-align: center;
        }

        #videoElement,
        #outputCanvas {
            width: 100%;
            max-width: 320px;
            border-radius: var(--radius-md);
            margin-bottom: var(--space-sm);
            box-shadow: var(--shadow-md);
            background: black;
        }

        #currentGesture {
            font-size: 1.2rem;
            font-weight: bold;
            color: #00ff88;
            background: rgba(0, 0, 0, 0.6);
            padding: var(--space-xs) var(--space-md);
            border-radius: var(--radius-sm);
            display: inline-block;
        }

        /* Map Section */
        #map {
            height: 500px;
            border-radius: var(--radius-lg);
            border: 4px solid rgba(255, 255, 255, 0.3);
        }

        @media (max-width: 768px) {
            #gameArea {
                grid-template-columns: 1fr;
            }

            #map {
                height: 400px;
            }
        }
    </style>
</head>

<body class="theme-education">

    <nav class="u-nav" style="background: rgba(255,255,255,0.9);">
        <div class="u-container u-nav__container">
            <a href="index.html" class="u-nav__brand">ğŸŒ¿ Mengxi Times</a>
            <ul class="u-nav__links">
                <li><a href="index.html" class="u-nav__link">é¦–é¡µ</a></li>
                <li><a href="virtual-walk.html" class="u-nav__link u-nav__link--active">è¿”å›é”®ç›˜ç‰ˆ</a></li>
            </ul>
        </div>
    </nav>

    <main class="u-container" style="padding-top: var(--space-xl);">
        <header class="u-text-center u-mb-xl" style="color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
            <h1 class="u-text-4xl u-font-bold">ğŸ–ï¸ Virtual Walk - æ‰‹åŠ¿æ§åˆ¶ç‰ˆ</h1>
            <p class="u-text-lg">ä½¿ç”¨æ‘„åƒå¤´è¿›è¡Œæ‰‹åŠ¿æ§åˆ¶ (Beta)</p>
        </header>

        <div id="statusBar" class="glass-panel u-mb-lg u-flex u-justify-between u-text-white u-font-bold">
            <div id="gestureStatus">ç­‰å¾…å¯åŠ¨æ‘„åƒå¤´...</div>
            <div id="mapStatus">åœ°å›¾åŠ è½½ä¸­...</div>
        </div>

        <div id="gameArea">
            <!-- Camera & Gesture -->
            <div id="cameraSection" class="glass-panel">
                <video id="videoElement" width="320" height="240" autoplay muted playsinline
                    style="display: none;"></video>
                <canvas id="outputCanvas" width="320" height="240"></canvas>
                <div>
                    <div id="currentGesture">æ— æ‰‹åŠ¿</div>
                </div>
            </div>

            <!-- Map -->
            <div id="mapSection">
                <div id="map"></div>
            </div>
        </div>

        <div id="controlPanel" class="glass-panel u-text-center u-mb-xl">
            <button class="u-btn u-btn--primary" id="startCamera">å¯åŠ¨æ‘„åƒå¤´</button>
            <button class="u-btn u-btn--secondary" id="calibratePose">æ ¡å‡†å§¿æ€</button>
            <button class="u-btn u-btn--outline" style="color: white; border-color: white;" id="resetMap">é‡ç½®åœ°å›¾</button>
            <button class="u-btn u-btn--outline" style="color: white; border-color: white;"
                id="toggleLayer">åˆ‡æ¢è§†å›¾</button>
        </div>
    </main>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- MediaPipe Pose -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>

    <script>
        // Global Variables
        let map, pose, camera, videoElement, canvasElement, canvasCtx;
        let isCameraActive = false;
        let isSatelliteMode = false;
        let currentLocation = { lat: 48.8566, lng: 2.3522 };
        let currentZoom = 16;

        const standardLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });

        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        });

        function initMap() {
            map = L.map('map', { center: currentLocation, zoom: currentZoom, layers: [standardLayer] });
            L.marker(currentLocation).addTo(map);
            document.getElementById('mapStatus').textContent = 'åœ°å›¾åŠ è½½å®Œæˆ';
        }

        function initPose() {
            pose = new Pose({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
            });
            pose.setOptions({
                modelComplexity: 0,
                smoothLandmarks: true,
                enableSegmentation: false,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            pose.onResults(onPoseResults);
        }

        async function startCamera() {
            videoElement = document.getElementById('videoElement');
            canvasElement = document.getElementById('outputCanvas');
            canvasCtx = canvasElement.getContext('2d');
            try {
                // Not asking for stream instantly, Camera util handles it
                camera = new Camera(videoElement, {
                    onFrame: async () => { await pose.send({ image: videoElement }); },
                    width: 320, height: 240
                });
                camera.start();
                isCameraActive = true;
                document.getElementById('gestureStatus').textContent = 'æ‘„åƒå¤´å·²å¯åŠ¨ - æ­£åœ¨æ£€æµ‹æ‰‹åŠ¿';
                document.getElementById('startCamera').textContent = 'æ‘„åƒå¤´å·²å¯åŠ¨';
                document.getElementById('startCamera').disabled = true;
            } catch (error) {
                alert('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: ' + error.message);
            }
        }

        function onPoseResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            if (results.poseLandmarks) {
                drawPose(results.poseLandmarks);
                const gesture = detectGestures(results.poseLandmarks);
                document.getElementById('currentGesture').textContent = gesture || 'æ— æ‰‹åŠ¿';
                controlMapByGesture(gesture);
            }
            canvasCtx.restore();
        }

        function drawPose(landmarks) {
            // Simplified drawing for visual feedback
            drawConnectors(canvasCtx, landmarks, POSE_CONNECTIONS, { color: '#00FF00', lineWidth: 2 });
            drawLandmarks(canvasCtx, landmarks, { color: '#FF0000', lineWidth: 1 });
        }

        function detectGestures(landmarks) {
            try {
                const ls = landmarks[11], lw = landmarks[15];
                const rs = landmarks[12], rw = landmarks[16];
                // Forward: Hands Up
                if (lw.y < ls.y - 0.1 && rw.y < rs.y - 0.1) return "å‰è¿›";
                // Backward: Hands Down (relative to shoulders?) - usually default pose so logic needs specific trigger or just check if below hip
                // Keeping original logic
                if (lw.y > ls.y + 0.1 && rw.y > rs.y + 0.1) return "åé€€";
                // Left: Left hand out
                if (Math.abs(lw.x - ls.x) > 0.15 && lw.x < ls.x) return "å·¦è½¬";
                // Right: Right hand out
                if (Math.abs(rw.x - rs.x) > 0.15 && rw.x > rs.x) return "å³è½¬";
                return null;
            } catch (e) { return null; }
        }

        function controlMapByGesture(gesture) {
            if (!map || !gesture) return;
            const moveDistance = 0.001;
            switch (gesture) {
                case "å‰è¿›": currentLocation.lat += moveDistance; break;
                case "åé€€": currentLocation.lat -= moveDistance; break;
                case "å·¦è½¬": currentLocation.lng -= moveDistance; break;
                case "å³è½¬": currentLocation.lng += moveDistance; break;
            }
            map.panTo(currentLocation, { animate: true, duration: 0.5 });
            // Update marker?
            // Simplified for perf: usually better to move market
        }

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            initPose();
            document.getElementById('startCamera').addEventListener('click', startCamera);
            document.getElementById('calibratePose').addEventListener('click', () => alert('è¯·ä¿æŒç«™ç«‹å§¿åŠ¿5ç§’é’Ÿ'));
            document.getElementById('resetMap').addEventListener('click', () => { currentLocation = { lat: 48.8566, lng: 2.3522 }; map.setView(currentLocation, currentZoom); });
            document.getElementById('toggleLayer').addEventListener('click', () => {
                isSatelliteMode = !isSatelliteMode;
                if (isSatelliteMode) { map.removeLayer(standardLayer); map.addLayer(satelliteLayer); }
                else { map.removeLayer(satelliteLayer); map.addLayer(standardLayer); }
            });
        });
    </script>
</body>

</html>