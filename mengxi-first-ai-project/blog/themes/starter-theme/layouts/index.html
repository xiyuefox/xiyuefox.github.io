{{ define "main" }}
<div x-data="searchApp()" style="background-color: #f6f6ef; min-height: 80vh;">

    <!-- Search Bar (Always visible) -->
    <div style="padding: 10px; background-color: #f6f6ef; border-bottom: 2px solid #ff6600; margin-bottom: 10px;">
        <div class="u-flex u-items-center" style="gap: 10px;">
            <!-- Search Input -->
            <span style="font-weight: bold; color: black;">Search:</span>
            <input type="text" x-model="query" @input.debounce.300ms="performSearch()" class="hn-search-input"
                placeholder="Type to find articles..."
                style="flex-grow: 1; padding: 5px; border: 1px solid #828282; font-size: 10pt; font-family: monospace;">
        </div>
        <!-- Status / Search Mode Indicator -->
        <div style="font-size: 8pt; color: #828282; margin-top: 5px;" x-show="query.length > 0">
            <span x-text="results.length + ' result(s) found.'"></span>
        </div>
    </div>

    <!-- Mode 1: Default Static List (Visible when query is empty) -->
    <div class="hn-list" x-show="query.length === 0">
        {{ range $index, $page := first 30 (where .Site.RegularPages "Section" "posts") }}
        <div class="hn-item-container" id="post-{{ .File.UniqueID }}" style="margin-bottom: 5px;">
            <div class="hn-item">
                <span class="hn-rank">{{ add $index 1 }}.</span>
                <div class="votearrow" title="upvote"></div>
                <span class="hn-title"><a href="{{ .RelPermalink }}">{{ .Title }}</a></span>
                <span style="font-size: 10px; color: #828282;">(mengxi.space)</span>
            </div>
            <div class="hn-meta">
                {{ .ReadingTime }} min read |
                <a href="#" onclick="return hidePost(this, 'post-{{ .File.UniqueID }}')">hide</a>
            </div>
        </div>
        {{ end }}
    </div>

    <!-- Mode 2: Search Results (Visible when query is NOT empty) -->
    <div class="hn-list" x-show="query.length > 0" style="display: none;">
        <template x-for="(result, index) in results" :key="result.permalink">
            <div class="hn-item-container" style="margin-bottom: 5px;">
                <div class="hn-item">
                    <span class="hn-rank" x-text="(index + 1) + '.'"></span>
                    <div class="votearrow" title="upvote"></div>
                    <span class="hn-title">
                        <a :href="result.permalink" x-text="result.title"></a>
                    </span>
                    <span style="font-size: 10px; color: #828282;">(mengxi.space)</span>
                </div>

                <div class="hn-meta">
                    <span x-text="new Date(result.date).toISOString().split('T')[0]"></span> |
                    <!-- Show match score as 'points' -->
                    <span x-text="Math.floor((1 - result.score) * 100) + ' points'"></span> |
                    <a href="#" onclick="return false;">hide</a>
                </div>
            </div>
        </template>

        <!-- No Results -->
        <div x-show="results.length === 0 && !isLoading"
            style="padding: 20px; text-align: center; color: #828282; font-size: 10pt;">
            No items found.
        </div>
    </div>

    <!-- External Links Section (Only Visible in List Mode) -->
    <div class="external-links" x-show="query.length === 0">
        <h3>ðŸ”— Related Resources</h3>
        <ul style="list-style: none; padding: 0; margin: 0;">
            <li>
                <a href="https://www.moreusefulthings.com/prompts" target="_blank" rel="noopener noreferrer">
                    More Useful Things - AI Prompts Collection
                </a>
            </li>
        </ul>
    </div>

</div>

<!-- Search App Logic -->
<script>
    function searchApp() {
        return {
            query: '',
            isLoading: false,
            documents: [],
            results: [],
            fuse: null,

            init() {
                // Preload index silently
                fetch('/index.json')
                    .then(response => response.json())
                    .then(data => {
                        this.documents = data;
                        const options = {
                            includeScore: true,
                            threshold: 0.4,
                            keys: [
                                { name: 'title', weight: 0.7 },
                                { name: 'tags', weight: 0.2 },
                                { name: 'summary', weight: 0.1 }
                            ]
                        };
                        this.fuse = new Fuse(this.documents, options);
                    })
                    .catch(error => console.error('Error fetching search index:', error));
            },

            performSearch() {
                if (this.query.length < 1) {
                    this.results = [];
                    return;
                }
                if (!this.fuse) return;

                this.isLoading = true;
                const fuseResults = this.fuse.search(this.query);

                this.results = fuseResults.map(res => ({
                    ...res.item,
                    score: res.score
                }));

                this.isLoading = false;
            }
        }
    }
</script>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.basic.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
{{ end }}