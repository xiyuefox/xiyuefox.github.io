{{ define "main" }}
<div x-data="searchApp()" style="background-color: #f6f6ef; min-height: 80vh;">
    <!-- HN Style Search Bar -->
    <div style="padding: 10px; background-color: #f6f6ef; border-bottom: 2px solid #ff6600; margin-bottom: 10px;">
        <div class="u-flex u-items-center" style="gap: 10px;">
            <span style="font-weight: bold; color: black;">Search:</span>
            <input type="text" x-model="query" @input.debounce.300ms="performSearch()" class="hn-search-input"
                placeholder="Type to find articles..."
                style="flex-grow: 1; padding: 5px; border: 1px solid #828282; font-size: 10pt; font-family: monospace;">
        </div>
        <div style="font-size: 8pt; color: #828282; margin-top: 5px;" x-text="statusMessage"></div>
    </div>

    <!-- HN List Results -->
    <div class="hn-list">
        <template x-for="(result, index) in results" :key="result.permalink">
            <div class="hn-item-container" style="margin-bottom: 5px;">
                <div class="hn-item">
                    <span class="hn-rank" x-text="(index + 1) + '.'"></span>
                    <div class="votearrow" title="upvote"></div>
                    <span class="hn-title">
                        <a :href="result.permalink" x-text="result.title"></a>
                    </span>
                    <span style="font-size: 10px; color: #828282;">(mengxi.space)</span>
                </div>

                <div class="hn-meta">
                    <span x-text="new Date(result.date).toISOString().split('T')[0]"></span> |
                    <!-- Show match score as 'points' -->
                    <span x-text="Math.floor((1 - result.score) * 100) + ' points'"></span> |
                    <a href="#" onclick="return false;">hide</a>
                </div>
            </div>
        </template>
    </div>

    <!-- No Results -->
    <div x-show="query.length > 0 && results.length === 0 && !isLoading"
        style="padding: 20px; text-align: center; color: #828282; font-size: 10pt;">
        No items found.
    </div>
</div>

<script>
    function searchApp() {
        return {
            query: '',
            isLoading: false,
            documents: [],
            results: [],
            fuse: null,
            statusMessage: 'Loading index...',

            init() {
                fetch('/index.json')
                    .then(response => response.json())
                    .then(data => {
                        this.documents = data;
                        // Initialize Fuse.js
                        const options = {
                            includeScore: true,
                            threshold: 0.4,
                            keys: [
                                { name: 'title', weight: 0.7 },
                                { name: 'tags', weight: 0.2 },
                                { name: 'summary', weight: 0.1 }
                            ]
                        };
                        this.fuse = new Fuse(this.documents, options);
                        this.statusMessage = '';
                    })
                    .catch(error => {
                        console.error('Error fetching search index:', error);
                        this.statusMessage = 'Error loading search service.';
                    });
            },

            performSearch() {
                if (this.query.length < 1) {
                    this.results = [];
                    return;
                }
                if (!this.fuse) return;

                this.isLoading = true;
                const fuseResults = this.fuse.search(this.query);

                // Map results but keep the score for the 'points' display
                this.results = fuseResults.map(res => ({
                    ...res.item,
                    score: res.score // 0 is perfect, 1 is bad
                }));

                this.isLoading = false;
            }
        }
    }
</script>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.basic.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
{{ end }}