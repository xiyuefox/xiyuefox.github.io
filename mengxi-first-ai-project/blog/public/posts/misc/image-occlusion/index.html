<!DOCTYPE html>
<html lang="zh-cn">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Image Occlusion | Mengxi&#39;s Blog</title>


<link href="https://fonts.googleapis.com" rel="preconnect" />
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
<link
    href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap"
    rel="stylesheet" />


<link rel="stylesheet" href="/css/unified-styles.css">
</head>

<body class="theme-knowledge">
    <nav class="u-nav">
    <div class="u-container u-nav__container">
        <a href="http://localhost:1313/" class="u-nav__brand">
            <span class="u-nav__logo-emoji">üåø</span> Mengxi&#39;s Blog
        </a>
        <ul class="u-nav__links">
            
            <li><a href="/" class="u-nav__link ">Home</a></li>
            
            <li><a href="/posts" class="u-nav__link ">Posts</a></li>
            
            <li><a href="/search" class="u-nav__link ">Search</a></li>
            
            <li><a href="/timeline/" class="u-nav__link ">Timeline</a></li>
            
            <li><a href="/guide/" class="u-nav__link ">Guide</a></li>
            
            <li><a href="/upload/" class="u-nav__link ">Upload</a></li>
            
        </ul>
    </div>
</nav>

    <main class="u-container u-py-xl">
        
<header class="u-text-center u-mb-xl">
    <h1>Image Occlusion</h1>
    <div class="u-flex u-justify-center u-gap-md u-text-light">
        <span>Dec 15, 2025</span>
        <span>‚Ä¢</span>
        <span>23 min read</span>
    </div>
</header>

<article class="u-card" style="max-width: 800px; margin: 0 auto;">
    <div class="content">
        <p>/*</p>
<h1 id="image-occlusion-for-excalidraw">Image Occlusion for Excalidraw</h1>
<p>This script creates image occlusion cards similar to Anki&rsquo;s Image Occlusion Enhanced plugin.</p>
<h2 id="usage">Usage:</h2>
<ol>
<li>Insert an image into Excalidraw</li>
<li>Draw rectangles or ellipses over areas you want to occlude</li>
<li>Select the image and all shapes you want to use as masks</li>
<li>Run this script</li>
<li>Choose occlusion mode:
<ul>
<li>‚≠ê‚†Ä      Add Cards:    Hide One, Guess One: Creates cards where only one shape is hidden at a time</li>
<li>‚≠ê‚≠ê     Add Cards:    Hide All, Guess One: Creates cards where all shapes are hidden except one</li>
<li>üóëÔ∏è‚†Ä      Delete Cards: Delete old cards (add DELETE marker): Marks all existing cards for deletion by adding DELETE marker</li>
<li>üóëÔ∏èüí•     Delete Cards: Delete old cards file and related images (Be Cautious!! Physical Delection): Permanently deletes all related card files and images</li>
</ul>
</li>
</ol>
<p>The script will generate masked versions of the image and save them locally.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#f92672">*</span><span style="color:#960050;background-color:#1e0010">/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Check minimum required version of Excalidraw plugin
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">ea</span>.<span style="color:#a6e22e">verifyMinimumPluginVersion</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">ea</span>.<span style="color:#a6e22e">verifyMinimumPluginVersion</span>(<span style="color:#e6db74">&#34;1.9.0&#34;</span>)) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Notice</span>(<span style="color:#e6db74">&#34;This script requires a newer version of Excalidraw. Please install the latest version.&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Get all selected elements from the canvas
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">elements</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ea</span>.<span style="color:#a6e22e">getViewSelectedElements</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Find all selected image elements
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">selectedImages</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">elements</span>.<span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">el</span> =&gt; <span style="color:#a6e22e">el</span>.<span style="color:#a6e22e">type</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;image&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Get all non-image elements to use as masks
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">maskElements</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">elements</span>.<span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">el</span> =&gt; <span style="color:#a6e22e">el</span>.<span style="color:#a6e22e">type</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#34;image&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Group masks based on their grouping in Excalidraw
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">maskGroups</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ea</span>.<span style="color:#a6e22e">getMaximumGroups</span>(<span style="color:#a6e22e">maskElements</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Process each mask or group of masks
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">masks</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">maskGroups</span>.<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">group</span> =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// If group contains only one element, return that element
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">group</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">group</span>[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// If group contains multiple elements, return the group info
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;group&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elements</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">group</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">group</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">groupIds</span><span style="color:#f92672">?</span>.[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">||</span> <span style="color:#a6e22e">ea</span>.<span style="color:#a6e22e">generateElementId</span>()
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Validate selection - must have one image and at least one mask
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">selectedImages</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">masks</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Notice</span>(<span style="color:#e6db74">&#34;Please select at least one image and one element or group to use as mask&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Verify the selected image and masks are properly grouped
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">validateSelection</span> <span style="color:#f92672">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Get combined bounds of all selected images
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">combinedBounds</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">selectedImages</span>.<span style="color:#a6e22e">reduce</span>((<span style="color:#a6e22e">bounds</span>, <span style="color:#a6e22e">img</span>) =&gt; ({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">minX</span><span style="color:#f92672">:</span> Math.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">bounds</span>.<span style="color:#a6e22e">minX</span>, <span style="color:#a6e22e">img</span>.<span style="color:#a6e22e">x</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">maxX</span><span style="color:#f92672">:</span> Math.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">bounds</span>.<span style="color:#a6e22e">maxX</span>, <span style="color:#a6e22e">img</span>.<span style="color:#a6e22e">x</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">img</span>.<span style="color:#a6e22e">width</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">minY</span><span style="color:#f92672">:</span> Math.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">bounds</span>.<span style="color:#a6e22e">minY</span>, <span style="color:#a6e22e">img</span>.<span style="color:#a6e22e">y</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">maxY</span><span style="color:#f92672">:</span> Math.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">bounds</span>.<span style="color:#a6e22e">maxY</span>, <span style="color:#a6e22e">img</span>.<span style="color:#a6e22e">y</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">img</span>.<span style="color:#a6e22e">height</span>)
</span></span><span style="display:flex;"><span>  }), {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">minX</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">Infinity</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">maxX</span><span style="color:#f92672">:</span> <span style="color:#f92672">-</span><span style="color:#66d9ef">Infinity</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">minY</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">Infinity</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">maxY</span><span style="color:#f92672">:</span> <span style="color:#f92672">-</span><span style="color:#66d9ef">Infinity</span>
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Remove bounds checking and always return true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Validate selection before proceeding
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">validateSelection</span>()) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Present user with operation mode choices
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">mode</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">suggester</span>(
</span></span><span style="display:flex;"><span>  [
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;‚≠ê‚†Ä      Add Cards:    Hide One, Guess One&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;‚≠ê‚≠ê     Add Cards:    Hide All, Guess One&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;üóëÔ∏è‚†Ä      Delete Cards: Delete old cards (add DELETE marker)&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;üóëÔ∏èüí•     Delete Cards: Delete old cards files and related images (Be Cautious!!)&#34;</span>
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  [<span style="color:#e6db74">&#34;hideOne&#34;</span>, <span style="color:#e6db74">&#34;hideAll&#34;</span>, <span style="color:#e6db74">&#34;delete&#34;</span>, <span style="color:#e6db74">&#34;deleteFiles&#34;</span>],
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Select operation mode&#34;</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Exit if user cancels the operation
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">mode</span>) <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Function to permanently delete related files and images
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">deleteRelatedFilesAndImages</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">sourcePath</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Add delay function for async operations
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">delay</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ms</span> =&gt; <span style="color:#66d9ef">new</span> Promise(<span style="color:#a6e22e">resolve</span> =&gt; <span style="color:#a6e22e">setTimeout</span>(<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">ms</span>));
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Initialize collections and counters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cardFiles</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Set</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">batchMarkers</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Set</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sourceFile</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">getAbstractFileByPath</span>(<span style="color:#a6e22e">sourcePath</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">deletedCardsCount</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">deletedFoldersCount</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">sourceFile</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Notice</span>(<span style="color:#e6db74">`Source file not found: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">sourcePath</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Get backlinks to find batch-marker.md files
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">backlinks</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">metadataCache</span>.<span style="color:#a6e22e">getBacklinksForFile</span>(<span style="color:#a6e22e">sourceFile</span>) <span style="color:#f92672">||</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Map</span>();
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Find all batch-marker.md files that link to the source file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">backlinks</span>.<span style="color:#a6e22e">data</span> <span style="color:#66d9ef">instanceof</span> <span style="color:#a6e22e">Map</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">filePath</span>, <span style="color:#a6e22e">_</span>] <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">backlinks</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">entries</span>()) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">filePath</span>.<span style="color:#a6e22e">endsWith</span>(<span style="color:#e6db74">&#39;batch-marker.md&#39;</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">markerFile</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">getAbstractFileByPath</span>(<span style="color:#a6e22e">filePath</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">markerFile</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">batchMarkers</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">markerFile</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">//  console.log(`Found batch marker: ${filePath}`);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">batchMarkers</span>.<span style="color:#a6e22e">size</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//  console.log(&#39;No batch markers found. Please check if the source file path is correct:&#39;, sourcePath);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Process each batch marker file to find cards
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">marker</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">batchMarkers</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// console.log(`Processing batch marker: ${marker.path}`);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">content</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">marker</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// console.log(&#34;Batch marker content:&#34;, content);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lines</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">content</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;\n&#39;</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Find the &#34;Generated Cards:&#34; section
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">startIndex</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lines</span>.<span style="color:#a6e22e">findIndex</span>(<span style="color:#a6e22e">line</span> =&gt; <span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">trim</span>() <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;Generated Cards:&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// console.log(&#34;Start index:&#34;, startIndex);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">startIndex</span> <span style="color:#f92672">!==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Process each card link after the &#34;Generated Cards:&#34; line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">startIndex</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">lines</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// console.log(&#34;Processing line:&#34;, lines[i]);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">match</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lines</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">match</span>(<span style="color:#e6db74">/\[\[([^\]]+)\]\]/</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">match</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cardPath</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">match</span>[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">// Use Obsidian&#39;s API to resolve wiki link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cardFile</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">metadataCache</span>.<span style="color:#a6e22e">getFirstLinkpathDest</span>(<span style="color:#a6e22e">cardPath</span>, <span style="color:#a6e22e">marker</span>.<span style="color:#a6e22e">path</span>);
</span></span><span style="display:flex;"><span>          
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">cardFile</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">cardFiles</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">cardFile</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// console.log(`Found card file through wiki link: ${cardFile.path}`);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// console.log(`Card file not found for wiki link: ${cardPath}`);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// First delete all card files
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">file</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">cardFiles</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">adapter</span>.<span style="color:#a6e22e">exists</span>(<span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">path</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Notify Obsidian&#39;s event system about the deletion
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">trigger</span>(<span style="color:#e6db74">&#34;delete&#34;</span>, <span style="color:#a6e22e">file</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#66d9ef">delete</span>(<span style="color:#a6e22e">file</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Add short delay to allow plugins to respond
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">delay</span>(<span style="color:#ae81ff">50</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">deletedCardsCount</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//  console.log(`Deleted card file: ${file.path}`);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">`Failed to delete card file: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">path</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, <span style="color:#a6e22e">error</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// Wait for file deletion operations to complete
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">delay</span>(<span style="color:#ae81ff">200</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Then delete batch marker folders
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">marker</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">batchMarkers</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">parentPath</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">marker</span>.<span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">substring</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">marker</span>.<span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">lastIndexOf</span>(<span style="color:#e6db74">&#39;/&#39;</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">parentFolder</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">getAbstractFileByPath</span>(<span style="color:#a6e22e">parentPath</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">parentFolder</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">adapter</span>.<span style="color:#a6e22e">exists</span>(<span style="color:#a6e22e">parentFolder</span>.<span style="color:#a6e22e">path</span>)) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Notify folder deletion
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">trigger</span>(<span style="color:#e6db74">&#34;delete&#34;</span>, <span style="color:#a6e22e">parentFolder</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#66d9ef">delete</span>(<span style="color:#a6e22e">parentFolder</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">delay</span>(<span style="color:#ae81ff">50</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">deletedFoldersCount</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//  console.log(`Deleted folder: ${parentFolder.path}`);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">`Failed to delete folder: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">parentFolder</span>.<span style="color:#a6e22e">path</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, <span style="color:#a6e22e">error</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Notice</span>(<span style="color:#e6db74">`Summary:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - Card files deleted: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">deletedCardsCount</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - Image folders deleted: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">deletedFoldersCount</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Function to get batch markers and their parent folders
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getBatchMarkersInfo</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">sourceFile</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">backlinks</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">metadataCache</span>.<span style="color:#a6e22e">getBacklinksForFile</span>(<span style="color:#a6e22e">sourceFile</span>) <span style="color:#f92672">||</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Map</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">batchMarkers</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Map</span>(); <span style="color:#75715e">// Map&lt;folderPath, Set&lt;markerFile&gt;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">backlinks</span>.<span style="color:#a6e22e">data</span> <span style="color:#66d9ef">instanceof</span> <span style="color:#a6e22e">Map</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">filePath</span>, <span style="color:#a6e22e">_</span>] <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">backlinks</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">entries</span>()) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">filePath</span>.<span style="color:#a6e22e">endsWith</span>(<span style="color:#e6db74">&#39;batch-marker.md&#39;</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">markerFile</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">getAbstractFileByPath</span>(<span style="color:#a6e22e">filePath</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">markerFile</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">folderPath</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">markerFile</span>.<span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">substring</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">markerFile</span>.<span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">lastIndexOf</span>(<span style="color:#e6db74">&#39;/&#39;</span>));
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">batchMarkers</span>.<span style="color:#a6e22e">has</span>(<span style="color:#a6e22e">folderPath</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">batchMarkers</span>.<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">folderPath</span>, <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Set</span>());
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">batchMarkers</span>.<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">folderPath</span>).<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">markerFile</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">batchMarkers</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Function to find and mark cards for deletion
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">deleteRelatedCards</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">sourcePath</span>, <span style="color:#a6e22e">selectedFolders</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cardFiles</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Set</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sourceFile</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">getAbstractFileByPath</span>(<span style="color:#a6e22e">sourcePath</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">totalCardsFound</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">totalNewlyMarked</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">totalAlreadyMarked</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">sourceFile</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Source file not found: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">sourcePath</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Get all batch markers grouped by folder
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">batchMarkersMap</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">getBatchMarkersInfo</span>(<span style="color:#a6e22e">sourceFile</span>);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">batchMarkersMap</span>.<span style="color:#a6e22e">size</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;No batch markers found&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Get batch markers to process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">batchMarkersToProcess</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Set</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">selectedFolders</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Convert to array if it&#39;s not already
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">folderArray</span> <span style="color:#f92672">=</span> Array.<span style="color:#a6e22e">isArray</span>(<span style="color:#a6e22e">selectedFolders</span>) <span style="color:#f92672">?</span> <span style="color:#a6e22e">selectedFolders</span> <span style="color:#f92672">:</span> [<span style="color:#a6e22e">selectedFolders</span>];
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Process each selected folder
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">folderArray</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">folder</span> =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">markers</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">batchMarkersMap</span>.<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">folder</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">markers</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">markers</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">marker</span> =&gt; <span style="color:#a6e22e">batchMarkersToProcess</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">marker</span>));
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Process all markers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">batchMarkersMap</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">markers</span> =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">markers</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">marker</span> =&gt; <span style="color:#a6e22e">batchMarkersToProcess</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">marker</span>));
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Process each batch marker file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">marker</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">batchMarkersToProcess</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// console.log(`Processing batch marker: ${marker.path}`);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">content</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">marker</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// console.log(&#34;Batch marker content:&#34;, content);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lines</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">content</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;\n&#39;</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Find the &#34;Generated Cards:&#34; section
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">startIndex</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lines</span>.<span style="color:#a6e22e">findIndex</span>(<span style="color:#a6e22e">line</span> =&gt; <span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">trim</span>() <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;Generated Cards:&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// console.log(&#34;Start index:&#34;, startIndex);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">startIndex</span> <span style="color:#f92672">!==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Process each card link after the &#34;Generated Cards:&#34; line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">startIndex</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">lines</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// console.log(&#34;Processing line:&#34;, lines[i]);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">match</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lines</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">match</span>(<span style="color:#e6db74">/\[\[([^\]]+)\]\]/</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">match</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cardPath</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">match</span>[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">// Use Obsidian&#39;s API to resolve wiki link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cardFile</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">metadataCache</span>.<span style="color:#a6e22e">getFirstLinkpathDest</span>(<span style="color:#a6e22e">cardPath</span>, <span style="color:#a6e22e">marker</span>.<span style="color:#a6e22e">path</span>);
</span></span><span style="display:flex;"><span>          
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">cardFile</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">cardFiles</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">cardFile</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//  console.log(`Found card file through wiki link: ${cardFile.path}`);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Card file not found for wiki link: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">cardPath</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Process each card file to add DELETE markers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">file</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">cardFiles</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// console.log(&#34;Processing card file:&#34;, file.path);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// Read file content and split into lines for processing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">content</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">file</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// console.log(&#34;Card content:&#34;, content);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lines</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">content</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;\n&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">modified</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">cardCount</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">alreadyMarkedCount</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Search for Anki card IDs and add DELETE marker before each
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">lines</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Look for Anki card ID pattern
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">idMatch</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lines</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">match</span>(<span style="color:#e6db74">/&lt;!--ID:.+?--&gt;/</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">idMatch</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// console.log(&#34;Found ID line:&#34;, lines[i]);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">cardCount</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cardId</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">idMatch</span>[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Check if DELETE marker already exists
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">i</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">lines</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>].<span style="color:#a6e22e">trim</span>() <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;DELETE&#39;</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">// console.log(&#34;DELETE marker already exists&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#a6e22e">alreadyMarkedCount</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Insert DELETE marker before the ID line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">lines</span>.<span style="color:#a6e22e">splice</span>(<span style="color:#a6e22e">i</span>, <span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#39;DELETE&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>; <span style="color:#75715e">// Skip the newly inserted line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">modified</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// console.log(&#34;Added DELETE marker before:&#34;, cardId);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Save changes if file was modified
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">modified</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// console.log(&#34;Saving modified content&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">modify</span>(<span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">lines</span>.<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#39;\n&#39;</span>));
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// console.log(&#34;No modifications needed&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">totalCardsFound</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">cardCount</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">totalNewlyMarked</span> <span style="color:#f92672">+=</span> (<span style="color:#a6e22e">cardCount</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">alreadyMarkedCount</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">totalAlreadyMarked</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">alreadyMarkedCount</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Notice</span>(<span style="color:#e6db74">`Summary:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - Files processed: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">cardFiles</span>.<span style="color:#a6e22e">size</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - Total cards found: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">totalCardsFound</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - Newly marked for deletion: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">totalNewlyMarked</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - Already marked for deletion: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">totalAlreadyMarked</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// If delete files mode is selected, delete all related files and exit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mode</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;deleteFiles&#34;</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Show confirmation dialog before permanent deletion
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">confirmed</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">suggester</span>(
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;Delete all files&#34;</span>, <span style="color:#e6db74">&#34;Select folders to delete&#34;</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;all&#34;</span>, <span style="color:#e6db74">&#34;select&#34;</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;WARNING: This will permanently delete all related card files and image folders. This action cannot be undone. Are you sure?&#34;</span>
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">confirmed</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Notice</span>(<span style="color:#e6db74">&#34;Operation cancelled&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">currentFile</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">getActiveFile</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">currentFile</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Get all batch markers and their folders
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">batchMarkersMap</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">getBatchMarkersInfo</span>(<span style="color:#a6e22e">currentFile</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">batchMarkersMap</span>.<span style="color:#a6e22e">size</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Notice</span>(<span style="color:#e6db74">&#34;No files found to delete&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">confirmed</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;select&#34;</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Sort folders alphabetically
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">folders</span> <span style="color:#f92672">=</span> Array.<span style="color:#a6e22e">from</span>(<span style="color:#a6e22e">batchMarkersMap</span>.<span style="color:#a6e22e">keys</span>()).<span style="color:#a6e22e">sort</span>();
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Let user select folders
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">selectedFolders</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">suggester</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">folders</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">folders</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Select folders to delete (ESC to cancel)&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">true</span>  <span style="color:#75715e">// Allow multi-select
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      );
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">selectedFolders</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">selectedFolders</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Ensure selectedFolders is an array
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>Array.<span style="color:#a6e22e">isArray</span>(<span style="color:#a6e22e">selectedFolders</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">selectedFolders</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">selectedFolders</span>];
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Delete files from selected folders
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">folder</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">selectedFolders</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">markers</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">batchMarkersMap</span>.<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">folder</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">markers</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">marker</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">markers</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Process each batch marker
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">content</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">marker</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lines</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">content</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;\n&#39;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">startIndex</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lines</span>.<span style="color:#a6e22e">findIndex</span>(<span style="color:#a6e22e">line</span> =&gt; <span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">trim</span>() <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;Generated Cards:&#39;</span>);
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">startIndex</span> <span style="color:#f92672">!==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>              <span style="color:#75715e">// Delete card files first
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>              <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">startIndex</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">lines</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">match</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lines</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">match</span>(<span style="color:#e6db74">/\[\[([^\]]+)\]\]/</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">match</span>) {
</span></span><span style="display:flex;"><span>                  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cardPath</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">match</span>[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>                  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cardFile</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">metadataCache</span>.<span style="color:#a6e22e">getFirstLinkpathDest</span>(<span style="color:#a6e22e">cardPath</span>, <span style="color:#a6e22e">marker</span>.<span style="color:#a6e22e">path</span>);
</span></span><span style="display:flex;"><span>                  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">cardFile</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                      <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#66d9ef">delete</span>(<span style="color:#a6e22e">cardFile</span>);
</span></span><span style="display:flex;"><span>                      <span style="color:#75715e">// console.log(`Deleted card file: ${cardFile.path}`);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>                      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">`Failed to delete card file: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">cardFile</span>.<span style="color:#a6e22e">path</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, <span style="color:#a6e22e">error</span>);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                  }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>              }
</span></span><span style="display:flex;"><span>              
</span></span><span style="display:flex;"><span>              <span style="color:#75715e">// Then delete the folder
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>              <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">parentFolder</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">getAbstractFileByPath</span>(<span style="color:#a6e22e">folder</span>);
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">parentFolder</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#66d9ef">delete</span>(<span style="color:#a6e22e">parentFolder</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>                  <span style="color:#75715e">//  console.log(`Deleted folder: ${folder}`);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>                  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">`Failed to delete folder: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">folder</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, <span style="color:#a6e22e">error</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>              }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Notice</span>(<span style="color:#e6db74">`Successfully deleted selected folders and their contents`</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Delete all files
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">currentFile</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">getActiveFile</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">currentFile</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">deleteRelatedFilesAndImages</span>(<span style="color:#a6e22e">currentFile</span>.<span style="color:#a6e22e">path</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Notice</span>(<span style="color:#e6db74">&#34;No source file found&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// If delete mode is selected, mark old cards for deletion and exit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mode</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;delete&#34;</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">currentFile</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">getActiveFile</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">currentFile</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Get all batch markers and their folders
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">batchMarkersMap</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">getBatchMarkersInfo</span>(<span style="color:#a6e22e">currentFile</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">batchMarkersMap</span>.<span style="color:#a6e22e">size</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Notice</span>(<span style="color:#e6db74">&#34;No cards found to delete&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Ask user whether to delete all or select folders
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">deleteChoice</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">suggester</span>(
</span></span><span style="display:flex;"><span>      [<span style="color:#e6db74">&#34;Delete all cards&#34;</span>, <span style="color:#e6db74">&#34;Select folders to delete&#34;</span>],
</span></span><span style="display:flex;"><span>      [<span style="color:#e6db74">&#34;all&#34;</span>, <span style="color:#e6db74">&#34;select&#34;</span>],
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;How would you like to delete cards?&#34;</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">deleteChoice</span>) <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">deleteChoice</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;select&#34;</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Sort folders alphabetically
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">folders</span> <span style="color:#f92672">=</span> Array.<span style="color:#a6e22e">from</span>(<span style="color:#a6e22e">batchMarkersMap</span>.<span style="color:#a6e22e">keys</span>()).<span style="color:#a6e22e">sort</span>();
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Let user select folders
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">selectedFolders</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">suggester</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">folders</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">folders</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Select folders to delete cards from (ESC to cancel)&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">true</span>  <span style="color:#75715e">// Allow multi-select
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      );
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">selectedFolders</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">selectedFolders</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Ensure selectedFolders is an array
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>Array.<span style="color:#a6e22e">isArray</span>(<span style="color:#a6e22e">selectedFolders</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">selectedFolders</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">selectedFolders</span>];
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Delete cards from selected folders
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">deleteRelatedCards</span>(<span style="color:#a6e22e">currentFile</span>.<span style="color:#a6e22e">path</span>, <span style="color:#a6e22e">selectedFolders</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Delete all cards
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">deleteRelatedCards</span>(<span style="color:#a6e22e">currentFile</span>.<span style="color:#a6e22e">path</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Extract original image name from the file ID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getImageName</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">fileId</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">imageData</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ea</span>.<span style="color:#a6e22e">targetView</span>.<span style="color:#a6e22e">excalidrawData</span>.<span style="color:#a6e22e">getFile</span>(<span style="color:#a6e22e">fileId</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">imageData</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">linkParts</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">original</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">pathParts</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">imageData</span>.<span style="color:#a6e22e">linkParts</span>.<span style="color:#a6e22e">original</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;/&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fileName</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">pathParts</span>[<span style="color:#a6e22e">pathParts</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fileName</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;.&#39;</span>)[<span style="color:#ae81ff">0</span>]; <span style="color:#75715e">// Remove extension
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;image&#39;</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Function to generate current timestamp for file names (For card file names)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getCurrentTimestamp</span> <span style="color:#f92672">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">now</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">baseTimestamp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">getFullYear</span>() <span style="color:#f92672">+</span> 
</span></span><span style="display:flex;"><span>                       (<span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">getMonth</span>() <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>).<span style="color:#a6e22e">toString</span>().<span style="color:#a6e22e">padStart</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;0&#39;</span>) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">getDate</span>().<span style="color:#a6e22e">toString</span>().<span style="color:#a6e22e">padStart</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;0&#39;</span>) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">getHours</span>().<span style="color:#a6e22e">toString</span>().<span style="color:#a6e22e">padStart</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;0&#39;</span>) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">getMinutes</span>().<span style="color:#a6e22e">toString</span>().<span style="color:#a6e22e">padStart</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;0&#39;</span>) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">getSeconds</span>().<span style="color:#a6e22e">toString</span>().<span style="color:#a6e22e">padStart</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;0&#39;</span>) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">getMilliseconds</span>().<span style="color:#a6e22e">toString</span>().<span style="color:#a6e22e">padStart</span>(<span style="color:#ae81ff">3</span>, <span style="color:#e6db74">&#39;0&#39;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">baseTimestamp</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Create timestamp for folder name (For folder naming)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">now</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">timestamp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">getFullYear</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;-&#39;</span> <span style="color:#f92672">+</span>  <span style="color:#75715e">// ‰ΩøÁî®ÂÆåÊï¥Âπ¥‰ªΩ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                 (<span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">getMonth</span>() <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>).<span style="color:#a6e22e">toString</span>().<span style="color:#a6e22e">padStart</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;0&#39;</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;-&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">getDate</span>().<span style="color:#a6e22e">toString</span>().<span style="color:#a6e22e">padStart</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;0&#39;</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39; &#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">getHours</span>().<span style="color:#a6e22e">toString</span>().<span style="color:#a6e22e">padStart</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;0&#39;</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;.&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">getMinutes</span>().<span style="color:#a6e22e">toString</span>().<span style="color:#a6e22e">padStart</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;0&#39;</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;.&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">getSeconds</span>().<span style="color:#a6e22e">toString</span>().<span style="color:#a6e22e">padStart</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;0&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Initialize or get script settings for card location
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">settings</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ea</span>.<span style="color:#a6e22e">getScriptSettings</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Default settings configuration
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">defaultSettings</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Output Base Folder&#34;</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Base folder for storing generated files. Always use forward slash &#39;/&#39; for paths. Example: &#39;Excalidraw-Image-Occlusions&#39;, &#39;Cards/Image-Occlusions&#39;&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">valueset</span><span style="color:#f92672">:</span> []  <span style="color:#75715e">// Empty array allows free text input
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Card Location&#34;</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;ask&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Where to save card files (&#39;default&#39; for same folder as images, or &#39;choose&#39; for custom location)&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">valueset</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;ask&#34;</span>, <span style="color:#e6db74">&#34;default&#34;</span>, <span style="color:#e6db74">&#34;choose&#34;</span>]
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Default Card Path&#34;</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Default path for card files when &#39;Card Location&#39; is set to &#39;default&#39;. Always use forward slash &#39;/&#39; for paths. Examples: &#39;flashcard/Anki&#39;, &#39;My Notes/Cards/Occlusion&#39;. Leave empty to save with images&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">valueset</span><span style="color:#f92672">:</span> []  <span style="color:#75715e">// Empty array allows free text input
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Default Template&#34;</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Default template file path relative to template folder (e.g., &#39;Anki/Image Occlusion.md&#39;). Leave empty to select template each time&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">valueset</span><span style="color:#f92672">:</span> []  <span style="color:#75715e">// Empty array allows free text input
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Card File Prefix&#34;</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Prefix for generated card files. Must be a valid filename without dots. Examples: &#39;anki - &#39;, &#39;card &#39;, &#39;io - &#39;. Leave empty for no prefix&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">valueset</span><span style="color:#f92672">:</span> []  <span style="color:#75715e">// Empty array allows free text input
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Card File Suffix&#34;</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Suffix for generated card files (before .md). Examples: &#39; -card.card3&#39; will generate &#39;prefix-timestamp-card.card3.md&#39;. Leave empty for no suffix&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">valueset</span><span style="color:#f92672">:</span> []  <span style="color:#75715e">// Empty array allows free text input
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Image Quality&#34;</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;1.5&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Export scale for image quality (e.g., 1.5). Higher values mean better quality but larger files. Must be a valid number.&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">valueset</span><span style="color:#f92672">:</span> []  <span style="color:#75715e">// Empty array allows free text input
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Hide All, Guess One - Highlight Color&#34;</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;#ffd700&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Color used to highlight the target mask in &#39;Hide All, Guess One&#39; mode (e.g., #ffd700 for gold, #ff0000 for red)&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">valueset</span><span style="color:#f92672">:</span> []  <span style="color:#75715e">// Empty array allows free text input
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Generate Images No Matter What&#34;</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;no&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Always generate images even when template selection is cancelled (yes/no)&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">valueset</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;yes&#34;</span>, <span style="color:#e6db74">&#34;no&#34;</span>]
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Initialize settings if they don&#39;t exist or merge with defaults
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">settings</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">settings</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">defaultSettings</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">ea</span>.<span style="color:#a6e22e">setScriptSettings</span>(<span style="color:#a6e22e">settings</span>);
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Check and add any missing settings
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">needsUpdate</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>  Object.<span style="color:#a6e22e">entries</span>(<span style="color:#a6e22e">defaultSettings</span>).<span style="color:#a6e22e">forEach</span>(([<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">defaultValue</span>]) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">settings</span>[<span style="color:#a6e22e">key</span>]) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">settings</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">defaultValue</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">needsUpdate</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">needsUpdate</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">ea</span>.<span style="color:#a6e22e">setScriptSettings</span>(<span style="color:#a6e22e">settings</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Validate and get image quality setting
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">validateQuality</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">quality</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Try to parse as float and check if it&#39;s a valid number
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> parseFloat(<span style="color:#a6e22e">quality</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">!</span>isNaN(<span style="color:#a6e22e">value</span>) <span style="color:#f92672">&amp;&amp;</span> isFinite(<span style="color:#a6e22e">value</span>) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">value</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Get image quality with validation
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">imageQuality</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">validateQuality</span>(<span style="color:#a6e22e">settings</span>[<span style="color:#e6db74">&#34;Image Quality&#34;</span>]<span style="color:#f92672">?</span>.<span style="color:#a6e22e">value</span>) 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">?</span> <span style="color:#a6e22e">settings</span>[<span style="color:#e6db74">&#34;Image Quality&#34;</span>].<span style="color:#a6e22e">value</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;1.5&#34;</span>;  <span style="color:#75715e">// Default to 1.5 if invalid
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Get and validate highlight color setting
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">validateColor</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">color</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Check if it&#39;s a valid hex color
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#e6db74">/^#[0-9A-Fa-f]{6}$/</span>.<span style="color:#a6e22e">test</span>(<span style="color:#a6e22e">color</span>);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Get highlight color with validation
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">highlightColor</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">validateColor</span>(<span style="color:#a6e22e">settings</span>[<span style="color:#e6db74">&#34;Hide All, Guess One - Highlight Color&#34;</span>]<span style="color:#f92672">?</span>.<span style="color:#a6e22e">value</span>) 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">?</span> <span style="color:#a6e22e">settings</span>[<span style="color:#e6db74">&#34;Hide All, Guess One - Highlight Color&#34;</span>].<span style="color:#a6e22e">value</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;#ffd700&#34;</span>;  <span style="color:#75715e">// Default to gold if invalid
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Function to prompt user for card file save location
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">askForCardLocation</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">imageFolder</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Use the initialized settings
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">locationSetting</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">settings</span>[<span style="color:#e6db74">&#34;Card Location&#34;</span>].<span style="color:#a6e22e">value</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">defaultPath</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">settings</span>[<span style="color:#e6db74">&#34;Default Card Path&#34;</span>]<span style="color:#f92672">?</span>.<span style="color:#a6e22e">value</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">trim</span>();
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// If setting is &#34;default&#34;, use configured path or image folder
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">locationSetting</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;default&#34;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">defaultPath</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Normalize path: replace backslashes and remove trailing slash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">normalizedPath</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">defaultPath</span>
</span></span><span style="display:flex;"><span>        .<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/\\/g</span>, <span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span>        .<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/\/+$/</span>, <span style="color:#e6db74">&#39;&#39;</span>);  <span style="color:#75715e">// Remove trailing slashes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Create default path if it doesn&#39;t exist
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">adapter</span>.<span style="color:#a6e22e">mkdir</span>(<span style="color:#a6e22e">normalizedPath</span>, { <span style="color:#a6e22e">recursive</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span> });
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">normalizedPath</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">imageFolder</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// If setting is &#34;choose&#34;, skip dialog and go straight to folder selection
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">locationSetting</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;choose&#34;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Get list of all available folders for user selection
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">folders</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">getAllLoadedFiles</span>()
</span></span><span style="display:flex;"><span>      .<span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">f</span> =&gt; <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">children</span>)
</span></span><span style="display:flex;"><span>      .<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">f</span> =&gt; <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">path</span>)
</span></span><span style="display:flex;"><span>      .<span style="color:#a6e22e">sort</span>();
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Let user choose from available folders
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">selectedFolder</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">suggester</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">folders</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">folders</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Select folder for card files&#34;</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Return null if user cancels folder selection
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">selectedFolder</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">undefined</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">selectedFolder</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">imageFolder</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// If setting is &#34;ask&#34;, show the choice dialog
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">choice</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">suggester</span>(
</span></span><span style="display:flex;"><span>    [
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">defaultPath</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">`Default location (</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">defaultPath</span><span style="color:#e6db74">}</span><span style="color:#e6db74">)`</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Default location (with images)&#34;</span>, 
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Choose custom location&#34;</span>
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;default&#34;</span>, <span style="color:#e6db74">&#34;custom&#34;</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Where would you like to save the card files?&#34;</span>
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// If user cancels (presses ESC), return null
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">choice</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">undefined</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Return default location if no choice or default selected
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">choice</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">choice</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;default&#34;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">defaultPath</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Normalize path: replace backslashes and remove trailing slash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">normalizedPath</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">defaultPath</span>
</span></span><span style="display:flex;"><span>        .<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/\\/g</span>, <span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span>        .<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/\/+$/</span>, <span style="color:#e6db74">&#39;&#39;</span>);  <span style="color:#75715e">// Remove trailing slashes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Create default path if it doesn&#39;t exist
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">adapter</span>.<span style="color:#a6e22e">mkdir</span>(<span style="color:#a6e22e">normalizedPath</span>, { <span style="color:#a6e22e">recursive</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span> });
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">normalizedPath</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">imageFolder</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Get list of all available folders for user selection
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">folders</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">getAllLoadedFiles</span>()
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">f</span> =&gt; <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">children</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">f</span> =&gt; <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">path</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">sort</span>();
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Let user choose from available folders
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">selectedFolder</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">suggester</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">folders</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">folders</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Select folder for card files&#34;</span>
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Return null if user cancels folder selection
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">selectedFolder</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">undefined</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">selectedFolder</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">imageFolder</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Function to construct image folder path using image name and timestamp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getImageFolder</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">imageName</span>, <span style="color:#a6e22e">timestamp</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">baseFolder</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">settings</span>[<span style="color:#e6db74">&#34;Output Base Folder&#34;</span>]<span style="color:#f92672">?</span>.<span style="color:#a6e22e">value</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">trim</span>() <span style="color:#f92672">||</span> <span style="color:#e6db74">&#34;Excalidraw-Image-Occlusions&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Normalize path and remove trailing slash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">normalizedBase</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">baseFolder</span>
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/\\/g</span>, <span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/\/+$/</span>, <span style="color:#e6db74">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">normalizedBase</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">imageName</span><span style="color:#e6db74">}</span><span style="color:#e6db74">__</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">timestamp</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Function to determine final output folder path based on settings or user choice
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getOutputFolder</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">imageName</span>, <span style="color:#a6e22e">timestamp</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Get default image folder path
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">imageFolder</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getImageFolder</span>(<span style="color:#a6e22e">imageName</span>, <span style="color:#a6e22e">timestamp</span>);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Return default path if settings specify default location
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">settings</span>[<span style="color:#e6db74">&#34;Card Location&#34;</span>].<span style="color:#a6e22e">value</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;default&#34;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">imageFolder</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Get list of all available folders for user selection
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">folders</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">getAllLoadedFiles</span>()
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">f</span> =&gt; <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">children</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">f</span> =&gt; <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">path</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">sort</span>();
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Let user choose output folder
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">selectedFolder</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">suggester</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">folders</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">folders</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Select folder for card files&#34;</span>
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Return default folder if no selection made
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">selectedFolder</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">imageFolder</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">selectedFolder</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Helper function to get current Excalidraw file path
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getCurrentFilePath</span> <span style="color:#f92672">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">file</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">getActiveFile</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">file</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">path</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Get current editing file name for folder naming
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getSourceFileName</span> <span style="color:#f92672">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">currentFile</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">getActiveFile</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">currentFile</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;image&#39;</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Remove extension and replace special characters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">currentFile</span>.<span style="color:#a6e22e">basename</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/[\\/:*?&#34;&lt;&gt;|]/g</span>, <span style="color:#e6db74">&#39;_&#39;</span>);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Create necessary folders for storing images and cards
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">imageName</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getSourceFileName</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">imageFolder</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getImageFolder</span>(<span style="color:#a6e22e">imageName</span>, <span style="color:#a6e22e">timestamp</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cardFolder</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">askForCardLocation</span>(<span style="color:#a6e22e">imageFolder</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Exit if user cancelled location selection
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">cardFolder</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Notice</span>(<span style="color:#e6db74">&#34;Operation cancelled&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Create image folder with all parent directories
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">adapter</span>.<span style="color:#a6e22e">mkdir</span>(<span style="color:#a6e22e">imageFolder</span>, { <span style="color:#a6e22e">recursive</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span> });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Create card folder if different from image folder
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">cardFolder</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">imageFolder</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">adapter</span>.<span style="color:#a6e22e">mkdir</span>(<span style="color:#a6e22e">cardFolder</span>, { <span style="color:#a6e22e">recursive</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span> });
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Create initial batch marker file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">createBatchMarker</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">sourceFile</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">content</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`Source: [[</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">sourceFile</span><span style="color:#e6db74">}</span><span style="color:#e6db74">|find edit source]]\n\nGenerated Cards:\n`</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fileName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">imageFolder</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/batch-marker.md`</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">create</span>(<span style="color:#a6e22e">fileName</span>, <span style="color:#a6e22e">content</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fileName</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Add card to batch marker
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">addCardToBatchMarker</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">cardPath</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">markerPath</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">imageFolder</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/batch-marker.md`</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">currentContent</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">getAbstractFileByPath</span>(<span style="color:#a6e22e">markerPath</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Use full path in batch-marker
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">newContent</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">currentContent</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">`[[</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">cardPath</span><span style="color:#e6db74">}</span><span style="color:#e6db74">]]\n`</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">modify</span>(<span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">getAbstractFileByPath</span>(<span style="color:#a6e22e">markerPath</span>), <span style="color:#a6e22e">newContent</span>);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Create batch marker file after folders are created
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sourceFile</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getCurrentFilePath</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">batchMarkerFile</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">createBatchMarker</span>(<span style="color:#a6e22e">sourceFile</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Function to convert base64 image data to binary format
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">base64ToBinary</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">base64</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Remove data URL prefix
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">base64Data</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">base64</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/^data:image\/png;base64,/</span>, <span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Convert base64 to binary string
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">binaryString</span> <span style="color:#f92672">=</span> window.<span style="color:#a6e22e">atob</span>(<span style="color:#a6e22e">base64Data</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Convert binary string to Uint8Array
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">bytes</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint8Array</span>(<span style="color:#a6e22e">binaryString</span>.<span style="color:#a6e22e">length</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">binaryString</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">bytes</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">binaryString</span>.<span style="color:#a6e22e">charCodeAt</span>(<span style="color:#a6e22e">i</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">bytes</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Function to generate image with specified visible and hidden masks
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">generateMaskedImage</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">visibleMasks</span> <span style="color:#f92672">=</span> [], <span style="color:#a6e22e">hiddenMasks</span> <span style="color:#f92672">=</span> []) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Combine all selected images and masks into one array
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">allElements</span> <span style="color:#f92672">=</span> [...<span style="color:#a6e22e">selectedImages</span>];
</span></span><span style="display:flex;"><span>  [...<span style="color:#a6e22e">visibleMasks</span>, ...<span style="color:#a6e22e">hiddenMasks</span>].<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">mask</span> =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">mask</span>.<span style="color:#a6e22e">type</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;group&#34;</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">allElements</span>.<span style="color:#a6e22e">push</span>(...<span style="color:#a6e22e">mask</span>.<span style="color:#a6e22e">elements</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">allElements</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">mask</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Copy elements to Excalidraw&#39;s editing area
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">ea</span>.<span style="color:#a6e22e">copyViewElementsToEAforEditing</span>(<span style="color:#a6e22e">allElements</span>);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Get and cache all selected images data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">img</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">selectedImages</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">imageData</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ea</span>.<span style="color:#a6e22e">targetView</span>.<span style="color:#a6e22e">excalidrawData</span>.<span style="color:#a6e22e">getFile</span>(<span style="color:#a6e22e">img</span>.<span style="color:#a6e22e">fileId</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">imageData</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">ea</span>.<span style="color:#a6e22e">imagesDict</span>[<span style="color:#a6e22e">img</span>.<span style="color:#a6e22e">fileId</span>] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">img</span>.<span style="color:#a6e22e">fileId</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dataURL</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">imageData</span>.<span style="color:#a6e22e">img</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mimeType</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">imageData</span>.<span style="color:#a6e22e">mimeType</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">created</span><span style="color:#f92672">:</span> Date.<span style="color:#a6e22e">now</span>()
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Configure visibility of masks for question image
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">visibleMasks</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">mask</span> =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">mask</span>.<span style="color:#a6e22e">type</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;group&#34;</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Set all elements in group to fully visible
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">mask</span>.<span style="color:#a6e22e">elements</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">el</span> =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">element</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ea</span>.<span style="color:#a6e22e">getElement</span>(<span style="color:#a6e22e">el</span>.<span style="color:#a6e22e">id</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">element</span>.<span style="color:#a6e22e">opacity</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>;
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Set single element to fully visible
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">element</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ea</span>.<span style="color:#a6e22e">getElement</span>(<span style="color:#a6e22e">mask</span>.<span style="color:#a6e22e">id</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">element</span>.<span style="color:#a6e22e">opacity</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Configure invisibility of masks for answer image
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">hiddenMasks</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">mask</span> =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">mask</span>.<span style="color:#a6e22e">type</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;group&#34;</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Set all elements in group to invisible
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">mask</span>.<span style="color:#a6e22e">elements</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">el</span> =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">element</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ea</span>.<span style="color:#a6e22e">getElement</span>(<span style="color:#a6e22e">el</span>.<span style="color:#a6e22e">id</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">element</span>.<span style="color:#a6e22e">opacity</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Set single element to invisible
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">element</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ea</span>.<span style="color:#a6e22e">getElement</span>(<span style="color:#a6e22e">mask</span>.<span style="color:#a6e22e">id</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">element</span>.<span style="color:#a6e22e">opacity</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Generate PNG with specific export settings
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">dataURL</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">ea</span>.<span style="color:#a6e22e">createPNGBase64</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>    parseFloat(<span style="color:#a6e22e">imageQuality</span>),
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">exportWithDarkMode</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">exportWithBackground</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">viewBackgroundColor</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;#ffffff&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">exportScale</span><span style="color:#f92672">:</span> parseFloat(<span style="color:#a6e22e">imageQuality</span>),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">quality</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Clear Excalidraw&#39;s editing area
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">ea</span>.<span style="color:#a6e22e">clear</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">dataURL</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Function to get available Templater templates
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getTemplates</span> <span style="color:#f92672">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Check if Templater plugin is installed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">templaterPlugin</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">plugins</span>.<span style="color:#a6e22e">plugins</span>[<span style="color:#e6db74">&#34;templater-obsidian&#34;</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">templaterPlugin</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Notice</span>(<span style="color:#e6db74">&#34;Templater plugin is not installed&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Check if template folder is configured
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">templateFolder</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">templaterPlugin</span>.<span style="color:#a6e22e">settings</span>.<span style="color:#a6e22e">templates_folder</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">templateFolder</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Notice</span>(<span style="color:#e6db74">&#34;Template folder is not set in Templater settings&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Get template folder and verify it exists
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">templates</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">getAbstractFileByPath</span>(<span style="color:#a6e22e">templateFolder</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">templates</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">templates</span>.<span style="color:#a6e22e">children</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Notice</span>(<span style="color:#e6db74">&#34;No templates found&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Return only markdown files from template folder
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">templates</span>.<span style="color:#a6e22e">children</span>.<span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">f</span> =&gt; <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">extension</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;md&#34;</span>);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Function to create card markdown file from template
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">createMarkdownFromTemplate</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">templatePath</span>, <span style="color:#a6e22e">cardNumber</span>, <span style="color:#a6e22e">imagePath</span>, <span style="color:#a6e22e">sourceFile</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">templaterPlugin</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">plugins</span>.<span style="color:#a6e22e">plugins</span>[<span style="color:#e6db74">&#34;templater-obsidian&#34;</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">template</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">templatePath</span>);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Convert absolute file paths to relative paths for Obsidian links
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">vaultPath</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">adapter</span>.<span style="color:#a6e22e">getBasePath</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">relativePath</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">question</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">imagePath</span>.<span style="color:#a6e22e">question</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#a6e22e">vaultPath</span>, <span style="color:#e6db74">&#39;&#39;</span>).<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/\\/g</span>, <span style="color:#e6db74">&#39;/&#39;</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">answer</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">imagePath</span>.<span style="color:#a6e22e">answer</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#a6e22e">vaultPath</span>, <span style="color:#e6db74">&#39;&#39;</span>).<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/\\/g</span>, <span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Replace template placeholders with actual values
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">content</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">template</span>
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/{{card_number}}/g</span>, <span style="color:#a6e22e">cardNumber</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/{{question}}/g</span>, <span style="color:#a6e22e">relativePath</span>.<span style="color:#a6e22e">question</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/{{answer}}/g</span>, <span style="color:#a6e22e">relativePath</span>.<span style="color:#a6e22e">answer</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/{{editSource}}/g</span>, <span style="color:#a6e22e">sourceFile</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/{{batchMarker}}/g</span>, <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">imageFolder</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/batch-marker.md`</span>);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Get and validate file prefix from settings
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">validatePrefix</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">prefix</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Allow trailing spaces but validate the actual prefix content
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">actualPrefix</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">prefix</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/^\s+|\s+$/g</span>, <span style="color:#e6db74">&#39;&#39;</span>);  <span style="color:#75715e">// Remove leading and trailing spaces for validation only
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">actualPrefix</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">/^[a-zA-Z0-9_\s-]+$/</span>.<span style="color:#a6e22e">test</span>(<span style="color:#a6e22e">actualPrefix</span>);
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Get and validate file suffix from settings
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">validateSuffix</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">suffix</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Allow trailing spaces but validate the actual suffix content
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">actualSuffix</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">suffix</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/^\s+|\s+$/g</span>, <span style="color:#e6db74">&#39;&#39;</span>);  <span style="color:#75715e">// Remove leading and trailing spaces for validation only
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">actualSuffix</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">/^[a-zA-Z0-9_\s\-.]+$/</span>.<span style="color:#a6e22e">test</span>(<span style="color:#a6e22e">actualSuffix</span>);  <span style="color:#75715e">// Allow dots in suffix
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  };
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">filePrefix</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">settings</span>[<span style="color:#e6db74">&#34;Card File Prefix&#34;</span>]<span style="color:#f92672">?</span>.<span style="color:#a6e22e">value</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#34;&#34;</span>;  <span style="color:#75715e">// Don&#39;t trim to keep original spaces
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">validatedPrefix</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">validatePrefix</span>(<span style="color:#a6e22e">filePrefix</span>) <span style="color:#f92672">?</span> <span style="color:#a6e22e">filePrefix</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">prefixPart</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">validatedPrefix</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Get and validate file suffix from settings
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fileSuffix</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">settings</span>[<span style="color:#e6db74">&#34;Card File Suffix&#34;</span>]<span style="color:#f92672">?</span>.<span style="color:#a6e22e">value</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#34;&#34;</span>;  <span style="color:#75715e">// Don&#39;t trim to keep original spaces
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">validatedSuffix</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">validateSuffix</span>(<span style="color:#a6e22e">fileSuffix</span>) <span style="color:#f92672">?</span> <span style="color:#a6e22e">fileSuffix</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">suffixPart</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">validatedSuffix</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Create new card file with generated content
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fileName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">cardFolder</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">prefixPart</span><span style="color:#e6db74">}${</span><span style="color:#a6e22e">cardNumber</span><span style="color:#e6db74">}${</span><span style="color:#a6e22e">suffixPart</span><span style="color:#e6db74">}</span><span style="color:#e6db74">.md`</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">create</span>(<span style="color:#a6e22e">fileName</span>, <span style="color:#a6e22e">content</span>);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Add card to batch marker after successful creation
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">addCardToBatchMarker</span>(<span style="color:#a6e22e">fileName</span>);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Function to get template file based on settings
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getTemplateFile</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">templates</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Get default template path from settings
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">defaultTemplate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">settings</span>[<span style="color:#e6db74">&#34;Default Template&#34;</span>]<span style="color:#f92672">?</span>.<span style="color:#a6e22e">value</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">trim</span>();
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">defaultTemplate</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Try to find the default template
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">templateFile</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">templates</span>.<span style="color:#a6e22e">find</span>(<span style="color:#a6e22e">t</span> =&gt; <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">endsWith</span>(<span style="color:#a6e22e">defaultTemplate</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">templateFile</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">templateFile</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// If no default template or not found, let user select
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">suggester</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">templates</span>.<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">t</span> =&gt; <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">basename</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">templates</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Select a template for the cards&#34;</span>
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Begin card generation process based on selected mode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">counter</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">templateFile</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;  <span style="color:#75715e">// Move templateFile declaration to outer scope
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mode</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;hideAll&#34;</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Get template selection from user for Hide All mode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">templates</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getTemplates</span>();
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Only try to get template if templates exist
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">templates</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Get template file based on settings or user selection
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">templateFile</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">getTemplateFile</span>(<span style="color:#a6e22e">templates</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Check if we should proceed without template
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">generateImagesNoMatterWhat</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">settings</span>[<span style="color:#e6db74">&#34;Generate Images No Matter What&#34;</span>]<span style="color:#f92672">?</span>.<span style="color:#a6e22e">value</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;yes&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">templateFile</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">generateImagesNoMatterWhat</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Notice</span>(<span style="color:#e6db74">&#34;Operation cancelled - no template selected&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Generate cards for each mask in Hide All mode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">masks</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Set current mask as hidden, all others as visible
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">hiddenMasks</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">masks</span>[<span style="color:#a6e22e">i</span>]];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">visibleMasks</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">masks</span>.<span style="color:#a6e22e">filter</span>((<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">index</span>) =&gt; <span style="color:#a6e22e">index</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">i</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Generate unique timestamp for this card
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fileTimestamp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getCurrentTimestamp</span>();
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create a copy of all masks and highlight the target mask
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">questionMasks</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">masks</span>.<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">mask</span> =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">mask</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">hiddenMasks</span>[<span style="color:#ae81ff">0</span>]) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Handle group type masks
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">mask</span>.<span style="color:#a6e22e">type</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;group&#34;</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>            ...<span style="color:#a6e22e">mask</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">elements</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">mask</span>.<span style="color:#a6e22e">elements</span>.<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">el</span> =&gt; ({
</span></span><span style="display:flex;"><span>              ...<span style="color:#a6e22e">el</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">strokeWidth</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">4</span>,              
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">strokeColor</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">highlightColor</span>,  
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">strokeStyle</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;solid&#34;</span>,        
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">roughness</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>                 
</span></span><span style="display:flex;"><span>            }))
</span></span><span style="display:flex;"><span>          };
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Handle single element masks
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>          ...<span style="color:#a6e22e">mask</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">strokeWidth</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">4</span>,              
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">strokeColor</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">highlightColor</span>,  
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">strokeStyle</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;solid&#34;</span>,        
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">roughness</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>                 
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">mask</span>;
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">templateFile</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">generateImagesNoMatterWhat</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Generate question image with all masks visible
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">questionDataURL</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">generateMaskedImage</span>(<span style="color:#a6e22e">questionMasks</span>, []);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">questionPath</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">imageFolder</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/q-</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">fileTimestamp</span><span style="color:#e6db74">}</span><span style="color:#e6db74">.png`</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">adapter</span>.<span style="color:#a6e22e">writeBinary</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">questionPath</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">base64ToBinary</span>(<span style="color:#a6e22e">questionDataURL</span>)
</span></span><span style="display:flex;"><span>      );
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Generate answer image with one mask hidden and others visible
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">dataURL</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">generateMaskedImage</span>(<span style="color:#a6e22e">visibleMasks</span>, <span style="color:#a6e22e">hiddenMasks</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">imagePath</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">imageFolder</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/a-</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">fileTimestamp</span><span style="color:#e6db74">}</span><span style="color:#e6db74">.png`</span>;
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Save answer image to disk
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">adapter</span>.<span style="color:#a6e22e">writeBinary</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">imagePath</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">base64ToBinary</span>(<span style="color:#a6e22e">dataURL</span>)
</span></span><span style="display:flex;"><span>      );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Only create markdown file if template was selected
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">templateFile</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fullPaths</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">question</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">adapter</span>.<span style="color:#a6e22e">getFullPath</span>(<span style="color:#a6e22e">questionPath</span>),
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">answer</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">adapter</span>.<span style="color:#a6e22e">getFullPath</span>(<span style="color:#a6e22e">imagePath</span>)
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">createMarkdownFromTemplate</span>(
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">templateFile</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">fileTimestamp</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">fullPaths</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">sourceFile</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mode</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;hideOne&#34;</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Process Hide One, Guess One mode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">templates</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getTemplates</span>();
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Only try to get template if templates exist
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">templates</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">templateFile</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">getTemplateFile</span>(<span style="color:#a6e22e">templates</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Check if we should proceed without template
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">generateImagesNoMatterWhat</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">settings</span>[<span style="color:#e6db74">&#34;Generate Images No Matter What&#34;</span>]<span style="color:#f92672">?</span>.<span style="color:#a6e22e">value</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;yes&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">templateFile</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">generateImagesNoMatterWhat</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Notice</span>(<span style="color:#e6db74">&#34;Operation cancelled - no template selected&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">templateFile</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">generateImagesNoMatterWhat</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Generate common answer image first (all masks hidden)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">commonAnswerTimestamp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getCurrentTimestamp</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">commonAnswerDataURL</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">generateMaskedImage</span>([], <span style="color:#a6e22e">masks</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">commonAnswerPath</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">imageFolder</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/a-</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">commonAnswerTimestamp</span><span style="color:#e6db74">}</span><span style="color:#e6db74">.png`</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">adapter</span>.<span style="color:#a6e22e">writeBinary</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">commonAnswerPath</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">base64ToBinary</span>(<span style="color:#a6e22e">commonAnswerDataURL</span>)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Get full path for common answer image
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">commonAnswerFullPath</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">adapter</span>.<span style="color:#a6e22e">getFullPath</span>(<span style="color:#a6e22e">commonAnswerPath</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Process each mask individually
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">mask</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">masks</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Set current mask as visible, others as hidden for question
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">visibleMasks</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">masks</span>.<span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">m</span> =&gt; <span style="color:#a6e22e">m</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">mask</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">hiddenMasks</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">mask</span>];
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Generate unique timestamp for this card
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fileTimestamp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getCurrentTimestamp</span>();
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Generate question image showing only the current mask
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">questionDataURL</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">generateMaskedImage</span>([<span style="color:#a6e22e">mask</span>], <span style="color:#a6e22e">visibleMasks</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">questionPath</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">imageFolder</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/q-</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">fileTimestamp</span><span style="color:#e6db74">}</span><span style="color:#e6db74">.png`</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">adapter</span>.<span style="color:#a6e22e">writeBinary</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">questionPath</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">base64ToBinary</span>(<span style="color:#a6e22e">questionDataURL</span>)
</span></span><span style="display:flex;"><span>      );
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Only create markdown file if template was selected
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">templateFile</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fullPaths</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">question</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">vault</span>.<span style="color:#a6e22e">adapter</span>.<span style="color:#a6e22e">getFullPath</span>(<span style="color:#a6e22e">questionPath</span>),
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">answer</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">commonAnswerFullPath</span>
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">createMarkdownFromTemplate</span>(
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">templateFile</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">fileTimestamp</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">fullPaths</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">sourceFile</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mode</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;deleteFiles&#34;</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">currentFile</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">getActiveFile</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">currentFile</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Get all batch markers and their folders
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">batchMarkersMap</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">getBatchMarkersInfo</span>(<span style="color:#a6e22e">currentFile</span>);
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">batchMarkersMap</span>.<span style="color:#a6e22e">size</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Notice</span>(<span style="color:#e6db74">&#34;No files found to delete&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// ... rest of deleteFiles mode code remains the same ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;Error during file deletion:&#34;</span>, <span style="color:#a6e22e">error</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Notice</span>(<span style="color:#e6db74">&#34;Error occurred during file deletion&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Move completion message inside a try-catch block
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">templateFile</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">settings</span>[<span style="color:#e6db74">&#34;Generate Images No Matter What&#34;</span>]<span style="color:#f92672">?</span>.<span style="color:#a6e22e">value</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;yes&#34;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">messagePrefix</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">templateFile</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;Generated&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Generated images only with&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Notice</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">messagePrefix</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">masks</span>.<span style="color:#a6e22e">length</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> sets of files in </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">imageFolder</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/`</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;Error showing completion message:&#34;</span>, <span style="color:#a6e22e">error</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Notice</span>(<span style="color:#e6db74">&#34;Operation completed with some errors&#34;</span>);
</span></span><span style="display:flex;"><span>} 
</span></span></code></pre></div>
    </div>
</article>

    </main>

    <footer class="u-container u-py-xl u-text-center">
    <div class="u-mb-md">
        <span class="u-text-2xl">üå±</span>
    </div>
    <p class="u-text-light">
        ¬© 2025 Mengxi&#39;s Blog. Cultivated with intention.
    </p>
</footer>
</body>

</html>